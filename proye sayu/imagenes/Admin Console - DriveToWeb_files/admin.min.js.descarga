(function(n,e,v){function z(a,d,f){console.log(a);a&&(403==a.status&&5>d?setTimeout(f,1E3*Math.pow(2,d)+1E3*Math.random()):401==a.status?n.location.href=n.location.href.split("#")[0]:404==a.status&&(e.querySelector("#looking").classList.add("hidden"),e.querySelector("#nofile").classList.remove("hidden")))}function C(a,d,f,h,g){g=g||0;var c=d[a];c&&c.parent&&!d.hasOwnProperty(c.parent)&&(c.wip=!0,d[c.parent]={wip:!0},urlFileRec="https://www.googleapis.com/drive/v3/files/"+c.parent+"?fields=name%2Cparents",
v.ajax({url:urlFileRec,beforeSend:function(b){b.setRequestHeader("Authorization",h+" "+f)},success:function(b){return function(k){c=d[b];c.wip=!1;d[c.parent]={name:k.name,uri:encodeURIComponent(k.name),wip:!1};k.parents?d[c.parent].parent=k.parents[0]:d[c.parent].isRoot=!0}}(a),error:function(b){return function(k){c=d[b];c.wip=!1;delete d[c.parent];z(k,g,function(){C(b,d,f,h,g++)})}}(a)}))}function O(a,d,f){var h=0,g=0,c;for(c in a)if(a.hasOwnProperty(c)){h++;var b=a[c];if(!b.wip)if(b.parent)if(a.hasOwnProperty(b.parent)&&
!a[b.parent].wip&&A){var k=a[b.parent];k.isRoot?(b.name="/"+b.name,b.uri="/"+b.uri,A!=b.parent&&(b.unreachable=!0),delete b.parent,g++):(b.name=k.name+"/"+b.name,b.uri=k.uri+"/"+b.uri,b.parent=k.parent)}else b.isRoot||setTimeout(function(l){return function(){C(l,a,d,f,0)}}(c),300*(h+1));else g++}return g/h}function D(a,d,f,h,g){g=g||0;v.ajax({url:"https://www.googleapis.com/drive/v3/files?corpus=user&pageSize=1000&q=mimeType%3D'text%2Fhtml'+and+not+trashed&fields=files(id%2Cname%2Cparents%2Cpermissions%2Cshared%2CwebContentLink)&orderBy=modifiedTime%20desc",
beforeSend:function(c){c.setRequestHeader("Authorization",h+" "+f)},success:function(c){if(c&&c.files&&0<c.files.length){for(var b={},k=0;k<c.files.length;k++){var l=c.files[k],m=!1;if(l.permissions&&0<l.permissions.length)for(var r=0;!m&&r<l.permissions.length;r++)"anyone"==l.permissions[r].type&&(m=!0);else m=l.shared;m&&l.id&&l.name&&l.parents&&l.webContentLink&&(b[l.id]={name:"index.html"==l.name?"":l.name,uri:"index.html"==l.name?"":encodeURIComponent(l.name),parent:l.parents[0],mimeType:"text/html"})}var w=
setInterval(function(){var p=O(b,f,h);if(1==p||isNaN(p)){clearInterval(w);p=[];for(var q in b)b.hasOwnProperty(q)&&"text/html"==b[q].mimeType&&!b[q].unreachable&&p.push(b[q]);p.sort(function(P,Q){for(var E=P.name.split("/"),F=E.length,G=Q.name.split("/"),H=G.length,t=0,u=0;0==u&&t<F&&t<H;)u=E[t].localeCompare(G[t]),t++;0==u&&(u=F-H);return u});for(q=0;q<p.length;q++){var I=p[q],J=e.createElement("li"),x=e.createElement("a"),R=e.createTextNode("https://"+punycode.toUnicode(a)+I.name);x.setAttribute("href",
"https://"+a+I.uri);x.setAttribute("target","_blank");x.appendChild(R);J.appendChild(x);e.querySelector("ul#htmlLinks").appendChild(J)}y();e.querySelector("#looking").classList.add("hidden");e.querySelector(0==p.length?"#nofile":"#found").classList.remove("hidden")}},500)}else e.querySelector("#looking").classList.add("hidden"),e.querySelector("#nofile").classList.remove("hidden")},error:function(c){z(c,g,function(){D(a,d,f,h,g++)})}});setTimeout(function(){v.ajax({url:"https://www.googleapis.com/drive/v3/files/root?fields=id",
beforeSend:function(c){c.setRequestHeader("Authorization",h+" "+f)},success:function(c){A=c.id}})},250)}function K(a,d,f,h,g){g=g||0;var c="https://graph.microsoft.com/v1.0/me/drive/root/search(q='"+encodeURIComponent(".htm")+"')?$select=name,file,parentReference,shared";v.ajax({url:c,beforeSend:function(b){b.setRequestHeader("Authorization",h+" "+f)},success:function(b){if(b.value){for(var k=0,l=0;l<b.value.length;l++){var m=b.value[l];if(m.file&&m.file.mimeType)var r=m.file.mimeType;if(m.parentReference&&
m.parentReference.path&&m.name&&"text/html"==r){m=m.parentReference.path.replace("/drive/root:","")+"/"+("index.html"==m.name?"":encodeURIComponent(m.name));var w=e.createElement("li"),p=e.createElement("a"),q=e.createTextNode("https://"+punycode.toUnicode(a)+m);p.setAttribute("href","https://"+a+m);p.setAttribute("target","_blank");p.appendChild(q);w.appendChild(p);e.querySelector("ul#htmlLinks").appendChild(w);k++}}y();e.querySelector("#looking").classList.add("hidden");e.querySelector(0<k?"#found":
"#nofile").classList.remove("hidden")}},error:function(b){z(b,g,function(){K(a,d,f,h,g++)})}})}function y(){var a=e.getElementById("txtSiteName");a.value=a.value.toLowerCase();var d=punycode.toASCII(a.value),f=e.getElementById("tipSiteNameCheck"),h=d.length,g=e.getElementById("btnSetSiteName");g.disabled=!0;L===d?f.innerText="You may pick a new name.":/^[a-z0-9][a-z0-9-]{0,61}[a-z0-9]$/.test(d)&&a.value===punycode.toUnicode(d)?22>h?f.innerText=22-d.length+" chars too short.":(f.innerText=63-d.length+
" chars remaining.",g.disabled=!1):f.innerHTML='Ill-formed site name. Allowed: a-z, 0-9, interleaving dash, and Unicode as <a href="https://unicode.org/faq/idn.html" target="_blank">IDN</a>.'}function M(a,d,f){n.fetch("https://api.drv.tw/~"+a+"/"+d+"/?a=siteName",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({userName:a,serviceCode:d,siteName:f})}).then(function(h){return h.json()}).then(function(h){console.log(h);if("error"in
h){var g=e.getElementById("tipSiteNameCheck");switch(h.error){case "Name taken":g.innerText="Name taken. Please choose a different one.",e.getElementById("btnSetSiteName").disabled=!1}}else n.location.reload()})}function S(a){a=a.target;var d=e.querySelector("#"+a.getAttribute("data-target"));-1<(" "+d.className+" ").replace(/[\n\t]/g," ").indexOf(" open ")?(a.classList.remove("open"),d.classList.remove("open")):(a.classList.add("open"),d.classList.add("open"))}var A,L=null;n.onSiteNameChange=y;n.addEventListener("load",
function(){var a=n.location.href.match(/^https?:\/\/api.drv.tw\/~([^@]*@[^\/]*)\/([go]d)\/([^\?]*)\?(.*)$/),d="#",f={};if("#"==n.location.hash[0])for(var h=n.location.hash.substring(1).split("&"),g=0;g<h.length;g++){var c=h[g].split("=");2==c.length&&(f[c[0]]=decodeURIComponent(c[1]),"state"!==c[0]&&(d+=(1==d.length?"":"&")+h[g]))}if(a){var b=a[1],k=a[2];if(f.access_token){n.location.hash="authed=1";var l=n.location.protocol+"//"+n.location.host+n.location.pathname;n.fetch(l+"?a=siteName").then(function(m){return m.json()}).then(function(m){if(m&&
m.siteName){var r=m.siteName+".on.drv.tw";"gd"==k?D(r,l,f.access_token,f.token_type,0):"od"==k&&K(r,l,f.access_token,f.token_type,0);e.getElementById("txtSiteName").value=punycode.toUnicode(m.siteName);L=m.siteName;y();e.body.classList.remove("hidden");e.getElementById("experimental").classList.remove("hidden");e.getElementById("btnSetSiteName").onclick=function(){e.getElementById("btnSetSiteName").disabled=!0;M(b,k,punycode.toASCII(e.getElementById("txtSiteName").value))};e.getElementById("btnResetSiteName").onclick=
function(){e.getElementById("btnResetSiteName").disabled=!0;M(b,k,null)}}})}else"gd"==k?(a=n.location.href.replace(n.location.hash,""),a="https://accounts.google.com/o/oauth2/v2/auth?scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fdrive.readonly&redirect_uri=https://api.drv.tw/.b/gd/&state="+encodeURIComponent(a)+"&response_type=token&client_id=377757361231-areciaupege06ftl6ttshr4f93lnssbk.apps.googleusercontent.com&login_hint="+encodeURIComponent(b),n.location.href=a):"od"==k&&(a=n.location.href.replace(n.location.hash,
""),a="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?scope=Files.Read&redirect_uri=https://api.drv.tw/.b/od/&state="+encodeURIComponent(a)+"&response_type=token&client_id=228a690d-3bab-43cc-9ba2-2b121f20e8d0&login_hint="+encodeURIComponent(b),n.location.href=a)}else n.location.href.match(/\/\.b\/[go]d\//)&&f.state?n.location.href=f.state+d:n.location.href="https://www.drv.tw"});for(var N=e.querySelectorAll(".readmore"),B=0;B<N.length;B++)N[B].addEventListener("click",S)})(window,
document,jQuery);